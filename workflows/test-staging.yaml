apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: test-staging
spec:
  entrypoint: test-flow
  arguments:
    parameters:
    - name: model-version
    - name: staging-namespace
      value: "gourmetgram-staging"
    - name: staging-service
      value: "gourmetgram-app"
    - name: staging-port
      value: "8082"

  templates:
  - name: test-flow
    steps:
      # Step 1: Integration test - verify /test endpoint returns valid prediction
      - - name: integration-test
          template: check-predict
          arguments:
            parameters:
            - name: service-url
              value: "http://{{workflow.parameters.staging-service}}.{{workflow.parameters.staging-namespace}}.svc.cluster.local:{{workflow.parameters.staging-port}}"

      # Step 2: Resource test - verify pod is running (not OOMKilled/Pending/CrashLoopBackOff)
      - - name: resource-test
          template: check-pod-status
          arguments:
            parameters:
            - name: namespace
              value: "{{workflow.parameters.staging-namespace}}"

      # Step 3: Load test - verify p95 latency < 2000ms, success rate > 95%
      - - name: load-test
          template: run-load-test
          arguments:
            parameters:
            - name: service-url
              value: "http://{{workflow.parameters.staging-service}}.{{workflow.parameters.staging-namespace}}.svc.cluster.local:{{workflow.parameters.staging-port}}"

      # Step 4: Mark as approved in MLflow if all tests pass
      - - name: mark-staging-approved
          template: set-staging-approved
          arguments:
            parameters:
            - name: model-version
              value: "{{workflow.parameters.model-version}}"
          when: "'{{steps.integration-test.outputs.parameters.result}}' == 'pass' && '{{steps.resource-test.outputs.parameters.result}}' == 'pass' && '{{steps.load-test.outputs.parameters.result}}' == 'pass'"

      # Step 5: Branching logic - promote if tests pass, revert if tests fail
      - - name: promote-on-success
          template: trigger-promote
          arguments:
            parameters:
            - name: model-version
              value: "{{workflow.parameters.model-version}}"
          when: "'{{steps.integration-test.outputs.parameters.result}}' == 'pass' && '{{steps.resource-test.outputs.parameters.result}}' == 'pass' && '{{steps.load-test.outputs.parameters.result}}' == 'pass'"
        - name: revert-on-failure
          template: trigger-revert
          arguments:
            parameters:
            - name: model-version
              value: "{{workflow.parameters.model-version}}"
          when: "'{{steps.integration-test.outputs.parameters.result}}' == 'fail' || '{{steps.resource-test.outputs.parameters.result}}' == 'fail' || '{{steps.load-test.outputs.parameters.result}}' == 'fail'"

  # Template: Check /test endpoint (predict with test image)
  - name: check-predict
    inputs:
      parameters:
      - name: service-url
    outputs:
      parameters:
      - name: result
        valueFrom:
          path: /tmp/result.txt
    script:
      image: curlimages/curl:latest
      command: [sh]
      source: |
        #!/bin/sh
        echo "Testing integration: {{inputs.parameters.service-url}}/test"

        # Wait for service to be ready (max 60 seconds)
        for i in $(seq 1 12); do
          if curl -s -f "{{inputs.parameters.service-url}}/test" > /dev/null 2>&1; then
            echo "Service is ready"
            break
          fi
          echo "Waiting for service... ($i/12)"
          sleep 5
        done

        # Call /test endpoint (runs inference with hardcoded test image)
        RESPONSE=$(curl -s "{{inputs.parameters.service-url}}/test")
        echo "Response: $RESPONSE"

        # Verify response is not empty and is a valid food class name
        if [ -z "$RESPONSE" ]; then
          echo "✗ Integration test FAILED: Empty response"
          echo "fail" > /tmp/result.txt
        elif echo "$RESPONSE" | grep -qE "(Bread|Dairy product|Dessert|Egg|Fried food|Meat|Noodles/Pasta|Rice|Seafood|Soup|Vegetable/Fruit)"; then
          echo "✓ Integration test PASSED: Got valid prediction: $RESPONSE"
          echo "pass" > /tmp/result.txt
        else
          echo "✗ Integration test FAILED: Invalid response (not a valid food class)"
          echo "$RESPONSE"
              echo "fail" > /tmp/result.txt
          fi

  # Template: Set staging-approved alias in MLflow
  - name: set-staging-approved
    inputs:
      parameters:
      - name: model-version
    script:
      image: python:3.11-slim
      command: [sh, -c]
      source: |
        pip install mlflow-skinny > /dev/null
        export MLFLOW_TRACKING_URI=http://mlflow.gourmetgram-platform.svc.cluster.local:8000

        python -c "import mlflow; client = mlflow.tracking.MlflowClient(); client.set_registered_model_alias(name='GourmetGramFood11Model', alias='staging-approved', version='{{inputs.parameters.model-version}}')"

        echo "✓ Model version {{inputs.parameters.model-version}} marked as 'staging-approved' in MLflow"
        echo "This version has successfully passed all staging tests"

  # Template: Trigger promote-model workflow
  - name: trigger-promote
    inputs:
      parameters:
      - name: model-version
    resource:
      action: create
      manifest: |
        apiVersion: argoproj.io/v1alpha1
        kind: Workflow
        metadata:
          generateName: promote-model-
        spec:
          workflowTemplateRef:
            name: promote-model
          arguments:
            parameters:
            - name: source-environment
              value: "staging"
            - name: target-environment
              value: "canary"
            - name: model-version
              value: "{{inputs.parameters.model-version}}"

  # Template: Trigger revert-model workflow
  - name: trigger-revert
    inputs:
      parameters:
      - name: model-version
    resource:
      action: create
      manifest: |
        apiVersion: argoproj.io/v1alpha1
        kind: Workflow
        metadata:
          generateName: revert-staging-
        spec:
          workflowTemplateRef:
            name: revert-model
          arguments:
            parameters:
            - name: environment
              value: "staging"
            - name: failed-model-version
              value: "{{inputs.parameters.model-version}}"
            - name: failure-reason
              value: "Staging tests failed (integration/resource/load test)"
